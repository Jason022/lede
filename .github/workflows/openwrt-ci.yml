#
# This is free software, lisence use MI
# 
# Copyright (C) 2019 P3TERX <https://p3terx.com>
# Copyright (C) 2019 KFERMercer <KFER.Mercer@gmail.com>
# 
# <https://github.com/KFERMercer/OpenWrt-CI>
# 

name: OpenWrt-CI

on:
#  schedule:
#    - cron: 0 20 * * *
  push:
     branches: 
       - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@master
        with:
          ref: master

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi `docker images -q`
          echo "Deleting files, please wait ..."
          sudo rm -rf \
            /usr/share/dotnet \
            /etc/mysql \
            /etc/php
          sudo -E apt-get -y purge \
            azure-cli \
            ghc* \
            zulu* \
            hhvm \
            llvm* \
            firefox \
            google* \
            dotnet* \
            powershell \
            openjdk* \
            mysql* \
            php*
          sudo -E apt-get update
          sudo -E apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean

      - name: Update feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Costom configure file
        run: |
          rm -f ./.config*
          touch ./.config

          #
          # ========================固件定制部分========================
          # 
# K2p 固件配置:
cat >> .config <<EOF
CONFIG_TARGET_ramips=y
CONFIG_TARGET_ramips_mt7621=y
CONFIG_TARGET_ramips_mt7621_DEVICE_k2p=y
# CONFIG_TARGET_ramips_mt7620_DEVICE_ArcherC20i is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_ArcherC50v1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_ArcherMR200 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_ai-br100 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_alfa-network_ac1200rm is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_alfa-network_r36m-e4g is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_alfa-network_tube-e4g is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_bdcom_wap2100-sk is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_bocco is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_c108 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_cf-wr800n is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_cs-qr10 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_d240 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_db-wrt01 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dch-m225 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dir-810l is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dlink_dir-510l is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dlink_dwr-116-a1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dlink_dwr-118-a1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dlink_dwr-118-a2 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dlink_dwr-921-c1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dlink_dwr-921-c3 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_dlink_dwr-922-e2 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_e1700 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_edimax_br-6478ac-v2 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_ex3700-ex3800 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_gl-mt300a is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_gl-mt300n is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_gl-mt750 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_hc5661 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_hc5761 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_hc5861 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_head-weblink_hdrm200 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_iodata_wn-ac1167gr is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_iodata_wn-ac733gr3 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_kimax_u35wf is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_kn_rc is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_kn_rf is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_kng_rc is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_lava_lr-25g001 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_microwrt is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_miwifi-mini is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mlw221 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mlwg2 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mt7620a is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mt7620a_mt7530 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mt7620a_mt7610e is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mt7620a_v22sg is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mzk-750dhp is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mzk-ex300np is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_mzk-ex750np is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_na930 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_oy-0001 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_phicomm_k2g is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_psg1208 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_psg1218a is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_psg1218b is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_ravpower_wd03 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_rp-n53 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_rt-ac51u is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_rt-n12p is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_rt-n14u is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_tiny-ac is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_tplink_c2-v1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_tplink_c20-v1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_u25awf-h1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_vonets_var11n-300 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_we1026-5g-16m is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_whr-1166d is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_whr-300hp2 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_whr-600d is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_wmr-300 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_wn3000rpv3 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_wrh-300cr is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_wrtnode is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_wt3020-8M is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_y1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_y1s is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_youku-yk1 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zbt-ape522ii is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zbt-cpe102 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zbt-wa05 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zbt-we2026 is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zbt-we826-16M is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zbt-we826-32M is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zbt-wr8305rt is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zbtlink_zbt-we826-e is not set
# CONFIG_TARGET_ramips_mt7620_DEVICE_zte-q7 is not set
# CONFIG_TARGET_ramips_mt7620_Default is not set
# CONFIG_TARGET_x86_64 is not set
# CONFIG_TARGET_x86_64_Generic is not set
# CONFIG_TARGET_x86_core2 is not set
# CONFIG_TARGET_x86_generic is not set
# CONFIG_TARGET_x86_geode is not set
# CONFIG_TARGET_x86_legacy is not set
# CONFIG_TARGET_x86_zen is not set
# CONFIG_boost-compile-visibility-global is not set
# CONFIG_boost-compile-visibility-hidden is not set
# CONFIG_boost-compile-visibility-protected is not set
# CONFIG_boost-runtime-shared is not set
# CONFIG_boost-shared-libs is not set
# CONFIG_boost-static-and-shared-libs is not set
# CONFIG_boost-static-libs is not set
# CONFIG_boost-variant-debug is not set
# CONFIG_boost-variant-profile is not set
# CONFIG_boost-variant-release is not set
EOF
          # 
          # ========================固件定制部分结束========================
          # 

          sed -i 's/^[ \t]*//g' ./.config
          make defconfig

      - name: Make download
        run: |
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile firmware
        run: |
          echo -e "$(nproc) thread build."
          make -j$(nproc) V=s


      - name: Assemble artifact
        run: |
          rm -rf ./artifact/
          mkdir -p ./artifact/
          find ./bin/targets/ -name "*combined*img*" | xargs -i mv -f {} ./artifact/
          find ./bin/targets/ -name "*sysupgrade*bin*" | xargs -i mv -f {} ./artifact/

      - name: Upload artifact
        uses: actions/upload-artifact@master
        with:
          name: OpenWrt firmware
          path: ./artifact/
